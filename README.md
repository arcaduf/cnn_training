# CNN Training

<br>

## Description
This is an agile framework to train convolutional
neural network (CNN) models for either classification or regression
using Keras with Tensorflow backend. 

<br>

## Requirements

Python-3.6 ,  Keras-2.2.4 , Tensorflow-1.12.0.

<br>

## Built-in architectures
The CNN models available in Keras are: 
* *Xception*
* *VGG16*
* *VGG19*
* *ResNet50*
* *InceptionV3*
* *InceptionResNetV2*
* *MobileNet*
* *MobileNetV2*
* *Densenet-121*
* *Densenet-169*
* *Densenet-201*
* *Nasnet-Mobile*

For more information, visit [Keras applications](https://keras.io/applications/).

<br>

## Files
* __cnn_class.py__  main class loading input data and CNN architecture, compiling the model and run the training;
* __cnn_train.py__  script to execute training, it has dependency on *cnn_class.py*;
* __cnn_config.yml__  example of yaml config file to be used in input for training;
* __cnn_grid_search.py__ routine to run cross-validated grid search of the parameter space;
* __evaluate_grid_search.py__ routine to evaluate a cross-validated grid search; 
* __cnn_predict.py__ routine to load a model and run the prediction on a single image; the output is a CSV file;
* __cnn_run_predict.py__  script to slurm up *cnn_predict.py* on a dataset of images provided as CSV or a folder;
* __cnn_run_predict.yml__ example of yaml config file to be used as input for *cnn_run_predict.py*;
* __collect_oneline_csv.py__  script to collect all CSVs of individual predictions into a single CSV file;
* __cnn_data_augment.py__  routine to perform offline data augmentation with the library [imgaug](https://github.com/aleju/imgaug).
* __cnn_data_augment.yml__  example of yaml config file to be used input for *cnn_data_augment.py*;
* __cnn_split_table.py__  split CSV into training, testing and validation CSV, using a column as constraint (facultative) and guaranteeing the same balance among classes in all 3 sets;
* __cnn_roc_plot.py__  routine to plot a single ROC or the composite/separate ROC curves of a K-fold cross-validation run;
* __collate_trues_and_preds.py__ routine to collate ground truth and predictions in one JSON file ready to be used as input for *cnn_roc_plot.py*;
* __metrics.py__ library to compute metrics for classification, multi-label classification and regression;
* __wcce.py__ tensorflow package to embed asymettric weighting in the the training cost function.

<br>

## Help
Almost all python scripts handle input arguments through *argparse*. If you want to see the description of the input arguments
and some examples of command line to build type:
```
python <script> -h
```

<br>

## Training
Command line to train a single model for binary classification:
```
python cnn_train.py \ 
  -i1 < training CSV > 
  -i2 < testing CSV >
  -p < YAML comfig file >
  -o < output path > \ 
  -col-imgs < column containing the image filepaths > \
  -col-label < column containing the image labels >
```

The training will produce 3 output files: 
* a JSON file with the training history;
* a YAML file that is a copy of the config file used for training; 
* a HDF5 which contains the best model saved according to the chosen metric;
* a CSV logging all metrics related to the training; it is updated online.

For more information, including additional runnable examples, type 
```
python cnn_train.py -h
```
To complete a quick run to test whether everything works fine add the flag
```
--debug
```

<br>

## Cross-Validated Grid Search

The routine `cnn_grid_search.py` allows to quickly explore the space generated by 1 or multiple parameters
(up to 4). Each grid point can be cross-validated either by means of K-fold or random resampling cross-validation.

Command line for a cross-validated grid search:
```
python cnn_grid_search.py   
  -i < input CSV >             
  -o < output folder >
  -p < YAML config file >
  -c < type of cross-validation >
  -n < number of folds >
  --perc_valid < percentage of dataset for validation, if using random resampling >
  -col-constr < select column on which to constrain the split of the input CSV >
  -col-imgs < column containing the image filepaths >
  -col-label < column containing the image labels >
  -r1 < list of parameters to explore >
  -r2 < list of parameter values to use >
  -l < label to set the Slurm run >
  -e < specifiy your email to get notifications about the status of your jobs >
  --path-logs < path where to save Slurm logs >
  --qos < specify duration of your job >
  --myenv < specify which virtualenv to use for each job >
```

For more information, including additional runnable examples, type 
```
python cnn_grid_search.py -h
```
To complete a quick run to test whether everything works fine add the flag
```
--debug
```

<br>

## Predictions with Trained Model:
The routine `cnn_run_predict.py` allows to run forward predictions on an entire dataset provided as CSV
or as folder. Command line:
```
python cnn_run_predict.py \
   -i < YAML file for cnn_run_predict >
   -l < location where to dump the Slurm output files >
```


The routine `collect_oneline_csv.py` allow to aggregate in one CSV file all individual
forward predictions. Command line:
```
python collect_oneline_csv.py \ 
  -i < directory containing CSV of individual predictions >  \ 
  -o < output CSV aggregating the individual predictions > 
```

<br>

## Evaluate models
The routine `cnn_roc_plot.py` allows to plot ROC curves related to a binary classification problem.
Command line:
```
python cnn_roc_plot.py
  -i < either an input JSON or a folder with multiple JSONs > 
  -o < specify output folder > 
```

<br>

### Author
* **Filippo Arcadu** - January 2018


<br>

### Last Update
19.02.2019



